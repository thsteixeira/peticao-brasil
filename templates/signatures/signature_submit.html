{% extends 'base.html' %}

{% block title %}Assinar Peti√ß√£o - {{ petition.title }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-4 md:py-8">
    <!-- Breadcrumb -->
    <div class="mb-4 md:mb-6">
        <nav class="text-xs sm:text-sm text-gray-600 overflow-x-auto whitespace-nowrap">
            <a href="{% url 'petitions:home' %}" class="hover:text-blue-600">√çnicio</a>
            <span class="mx-2">‚Ä∫</span>
            <a href="{% url 'petitions:detail' uuid=petition.uuid slug=petition.slug %}" class="hover:text-blue-600">{{ petition.title|truncatewords:5 }}</a>
            <span class="mx-2">‚Ä∫</span>
            <span class="text-gray-900">Assinar Peti√ß√£o</span>
        </nav>
    </div>

    <!-- Petition Info -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-4 md:mb-6">
        <h1 class="text-xl sm:text-2xl font-bold text-gray-900 mb-2">Assinar Peti√ß√£o</h1>
        <p class="text-base sm:text-lg text-gray-700 mb-3 md:mb-4">{{ petition.title }}</p>
        <div class="flex flex-wrap items-center gap-2 sm:gap-4 text-xs sm:text-sm text-gray-600">
            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full">{{ petition.category.name }}</span>
            <span>üìä {{ petition.current_signatures|default:0 }} de {{ petition.signature_goal }} assinaturas</span>
        </div>
    </div>

    <!-- Instructions -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 sm:p-6 mb-4 md:mb-6">
        <div class="flex flex-col sm:flex-row items-start justify-between mb-3 md:mb-4 gap-2">
            <h2 class="text-lg sm:text-xl font-bold text-blue-900">üìã Instru√ß√µes Importantes</h2>
            <a href="{% url 'petitions:how_to_sign' %}" class="text-xs sm:text-sm text-blue-600 hover:text-blue-800 font-semibold whitespace-nowrap">
                üìñ Ver guia completo ‚Üí
            </a>
        </div>
        <ol class="space-y-2 text-sm sm:text-base text-gray-700">
            <li><strong>1.</strong> Certifique-se de que baixou o PDF oficial da peti√ß√£o</li>
            <li><strong>2.</strong> Assine o PDF usando sua assinatura digital Gov.br (certificado ICP-Brasil)</li>
            <li class="bg-yellow-50 border-l-4 border-yellow-500 pl-3 py-2 rounded"><strong>3.</strong> <span class="font-bold text-yellow-900">‚ö†Ô∏è Ap√≥s assinar no Gov.br, RETORNE √† plataforma e fa√ßa o upload do arquivo PDF assinado neste formul√°rio</span></li>
            <li><strong>4.</strong> Aguarde a verifica√ß√£o autom√°tica do certificado digital</li>
        </ol>
        <div class="mt-4 p-4 bg-white rounded border border-blue-300">
            <p class="text-sm text-gray-600">
                <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> O CPF informado deve ser o mesmo associado ao certificado digital utilizado para assinar o PDF.
                N√£o modifique o conte√∫do do PDF ap√≥s o download, pois isso invalidar√° a verifica√ß√£o.
            </p>
        </div>
        <div class="mt-4">
            <p class="text-sm text-gray-700">
                <strong>üí° Primeira vez assinando?</strong> Veja nosso 
                <a href="{% url 'petitions:how_to_sign' %}" class="text-blue-600 hover:underline font-semibold">guia passo a passo de como assinar com Gov.br</a>.
            </p>
        </div>
    </div>

    <!-- Signature Form -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 md:p-8">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 mb-4 md:mb-6">Enviar Assinatura Digital</h2>
        
        <form method="post" enctype="multipart/form-data" class="space-y-4 md:space-y-6">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
                <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}
            
            <!-- CPF Field -->
            <div>
                <label for="{{ form.cpf.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                    {{ form.cpf.label }}
                    <span class="text-red-500">*</span>
                </label>
                {{ form.cpf }}
                {% if form.cpf.help_text %}
                    <p class="mt-1 text-sm text-gray-500">{{ form.cpf.help_text }}</p>
                {% endif %}
                {% if form.cpf.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.cpf.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Full Name Field -->
            <div>
                <label for="{{ form.full_name.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                    {{ form.full_name.label }}
                    <span class="text-red-500">*</span>
                </label>
                {{ form.full_name }}
                {% if form.full_name.help_text %}
                    <p class="mt-1 text-sm text-gray-500">{{ form.full_name.help_text }}</p>
                {% endif %}
                {% if form.full_name.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.full_name.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Email Field -->
            <div>
                <label for="{{ form.email.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                    {{ form.email.label }}
                </label>
                {{ form.email }}
                {% if form.email.help_text %}
                    <p class="mt-1 text-sm text-gray-500">{{ form.email.help_text }}</p>
                {% endif %}
                {% if form.email.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.email.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Location Fields -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="{{ form.city.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        {{ form.city.label }}
                        <span class="text-red-500">*</span>
                    </label>
                    {{ form.city }}
                    {% if form.city.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.city.errors.0 }}</p>
                    {% endif %}
                </div>

                <div>
                    <label for="{{ form.state.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        {{ form.state.label }}
                        <span class="text-red-500">*</span>
                    </label>
                    {{ form.state }}
                    {% if form.state.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.state.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- PDF Upload Field -->
            <div>
                <label for="{{ form.signed_pdf.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                    {{ form.signed_pdf.label }}
                    <span class="text-red-500">*</span>
                </label>
                {{ form.signed_pdf }}
                {% if form.signed_pdf.help_text %}
                    <p class="mt-1 text-sm text-gray-500">{{ form.signed_pdf.help_text }}</p>
                {% endif %}
                {% if form.signed_pdf.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.signed_pdf.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Privacy Notice -->
            <div class="bg-green-50 border-2 border-green-400 rounded-lg p-4 mb-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-bold text-green-900 mb-2">üîí Prote√ß√£o de Dados Pessoais</h3>
                        <p class="text-sm text-gray-700">
                            <strong>O criador da peti√ß√£o ter√° acesso APENAS ao seu nome completo</strong> (extra√≠do do certificado digital). 
                            Seus dados de contato (email), localiza√ß√£o (cidade/estado), CPF e qualquer outra informa√ß√£o pessoal 
                            <strong>N√ÉO ser√£o compartilhados</strong> com o criador da peti√ß√£o.
                        </p>
                        <p class="text-xs text-gray-600 mt-2">
                            Seus dados s√£o protegidos conforme a LGPD. Consulte nossa 
                            <a href="{% url 'petitions:privacy_policy' %}" target="_blank" class="text-green-700 hover:text-green-900 underline font-semibold">Pol√≠tica de Privacidade</a> 
                            para mais informa√ß√µes.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Terms and Privacy Policy Acceptance -->
            <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                <div class="flex items-start">
                    <div class="flex items-center h-5">
                        {{ form.accept_terms }}
                    </div>
                    <div class="ml-3">
                        <label for="{{ form.accept_terms.id_for_label }}" class="text-sm font-semibold text-blue-900">
                            Li e aceito os 
                            <a href="{% url 'petitions:terms' %}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">Termos de Uso</a> 
                            e a 
                            <a href="{% url 'petitions:privacy_policy' %}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">Pol√≠tica de Privacidade</a>
                            <span class="text-red-600">*</span>
                        </label>
                        {% if form.accept_terms.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.accept_terms.errors.0 }}</p>
                        {% endif %}
                        <p class="mt-2 text-xs text-gray-600">
                            ‚ö†Ô∏è Ao assinar, voc√™ reconhece que esta √© uma plataforma sem fins lucrativos que n√£o se responsabiliza 
                            por perdas financeiras ou divulga√ß√£o de dados nas situa√ß√µes descritas nos Termos de Uso.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Turnstile CAPTCHA -->
            {% if TURNSTILE_ENABLED and TURNSTILE_SITE_KEY %}
            <div class="flex justify-center">
                <div class="cf-turnstile" 
                     data-sitekey="{{ TURNSTILE_SITE_KEY }}" 
                     data-callback="onTurnstileSuccess"
                     data-error-callback="onTurnstileError"
                     data-expired-callback="onTurnstileExpired">
                </div>
            </div>
            {{ form.turnstile_token }}
            {% if form.turnstile_token.errors %}
                <p class="mt-1 text-sm text-red-600 text-center">{{ form.turnstile_token.errors.0 }}</p>
            {% endif %}
            {% else %}
            <!-- DEBUG: Turnstile disabled -->
            <div class="bg-yellow-100 border border-yellow-300 text-yellow-800 px-4 py-3 rounded text-sm">
                ‚ö†Ô∏è DEBUG: TURNSTILE_ENABLED={{ TURNSTILE_ENABLED }}, SITE_KEY={{ TURNSTILE_SITE_KEY|default:"(not set)" }}
            </div>
            {% endif %}

            <!-- Submit Buttons -->
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold transition-colors">
                    ‚úçÔ∏è Enviar Assinatura
                </button>
                <a href="{% url 'petitions:detail' uuid=petition.uuid slug=petition.slug %}" 
                   class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-center">
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

{% if TURNSTILE_ENABLED and TURNSTILE_SITE_KEY %}
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<script>
// Global flag to track Turnstile status
window.turnstileReady = false;

window.onTurnstileSuccess = function(token) {
    console.log('‚úÖ Turnstile token received:', token.substring(0, 20) + '...');
    const field = document.getElementById('{{ form.turnstile_token.id_for_label }}');
    console.log('üîç Looking for field with ID:', '{{ form.turnstile_token.id_for_label }}');
    
    if (field) {
        field.value = token;
        window.turnstileReady = true;
        console.log('‚úÖ Token set successfully in field');
    } else {
        console.error('‚ùå Token field not found! ID:', '{{ form.turnstile_token.id_for_label }}');
        // Try to find any hidden input with turnstile in name
        const allInputs = document.querySelectorAll('input[type="hidden"]');
        console.log('üìã Available hidden inputs:', Array.from(allInputs).map(i => i.id || i.name));
    }
}

window.onTurnstileError = function(error) {
    console.error('‚ùå Turnstile error:', error);
    alert('Erro ao carregar verifica√ß√£o de seguran√ßa. Por favor, recarregue a p√°gina.');
}

window.onTurnstileExpired = function() {
    console.warn('‚ö†Ô∏è Turnstile token expired');
    window.turnstileReady = false;
    alert('Verifica√ß√£o expirou. Por favor, complete novamente.');
}

// Prevent form submission if Turnstile not ready
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('üìù Form submission attempt, Turnstile ready:', window.turnstileReady);
            if (!window.turnstileReady) {
                e.preventDefault();
                alert('Por favor, complete a verifica√ß√£o de seguran√ßa antes de enviar.');
                return false;
            }
        });
    }
    
    // Debug: Log when widget container is found
    const widgetContainer = document.querySelector('.cf-turnstile');
    if (widgetContainer) {
        console.log('‚úÖ Turnstile widget container found');
        console.log('üîë Site key:', widgetContainer.getAttribute('data-sitekey'));
    } else {
        console.error('‚ùå Turnstile widget container NOT found');
    }
});
</script>
{% endif %}

<script>
// CPF mask
document.addEventListener('DOMContentLoaded', function() {
    const cpfInput = document.getElementById('{{ form.cpf.id_for_label }}');
    if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                e.target.value = value;
            }
        });
    }
});
</script>
{% endblock %}
