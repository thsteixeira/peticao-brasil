{% extends "base.html" %}

{% block title %}{{ petition.get_meta_title }}{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Petition",
  "name": "{{ petition.title }}",
  "description": "{{ petition.get_meta_description }}",
  "url": "{{ petition.get_canonical_url }}",
  "image": "{{ petition.get_og_image_url }}",
  "datePublished": "{{ petition.created_at|date:'c' }}",
  "dateModified": "{{ petition.updated_at|date:'c' }}",
  "author": {
    "@type": "Person",
    "name": "{{ petition.creator.get_full_name }}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Peti√ß√£o Brasil",
    "url": "{{ request.scheme }}://{{ request.get_host }}"
  },
  "about": {
    "@type": "Thing",
    "name": "{{ petition.category.name }}"
  },
  "numberOfSignatures": {{ petition.signature_count }},
  "targetSignatures": {{ petition.signature_goal }},
  "inLanguage": "pt-BR"
}
</script>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Petition Header -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 md:p-8 mb-4 md:mb-6">
        <div class="flex flex-col sm:flex-row items-start justify-between mb-4 gap-3">
            <div class="flex-1 w-full">
                <span class="inline-block px-3 py-1 rounded-full text-xs sm:text-sm font-semibold mb-2" 
                      style="background-color: {{ petition.category.color }}22; color: {{ petition.category.color }}">
                    {{ petition.category.name }}
                </span>
                <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 mb-2">{{ petition.title }}</h1>
                <div class="flex flex-wrap items-center gap-2 sm:gap-4 text-xs sm:text-sm text-gray-600">
                    <span>Por {{ petition.creator.get_full_name }}</span>
                    <span class="hidden sm:inline">‚Ä¢</span>
                    <span>{{ petition.created_at|date:"d/m/Y" }}</span>
                    <span class="hidden sm:inline">‚Ä¢</span>
                    <span>{{ petition.view_count }} visualiza√ß√µes</span>
                </div>
            </div>
            {% if user == petition.creator %}
                <a href="{% url 'petitions:edit' petition.uuid %}" class="text-blue-600 hover:text-blue-800">
                    Editar
                </a>
            {% endif %}
        </div>
        
        <!-- Progress Bar -->
        <div class="mb-4 md:mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 gap-1">
                <span class="text-xl sm:text-2xl font-bold text-gray-900">
                    {{ petition.signature_count }} assinaturas
                </span>
                <span class="text-sm sm:text-base text-gray-600">
                    Meta: {{ petition.signature_goal }}
                </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 md:h-3">
                <div class="bg-blue-600 h-3 rounded-full transition-all" 
                     style="width: {{ petition.progress_percentage }}%"></div>
            </div>
            <p class="text-sm text-gray-600 mt-1">{{ petition.progress_percentage }}% da meta alcan√ßada</p>
        </div>
        
        <!-- Call to Action -->
        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
            {% if petition.pdf_url %}
                <a href="{{ petition.pdf_url }}" 
                   target="_blank"
                   class="flex-1 bg-blue-600 text-white px-4 sm:px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold transition-colors text-center text-sm sm:text-base">
                    üìÑ Baixar PDF para Assinar
                </a>
            {% else %}
                <button class="flex-1 bg-gray-400 text-white px-4 sm:px-6 py-3 rounded-lg cursor-not-allowed font-semibold text-sm sm:text-base" disabled>
                    ‚è≥ Gerando PDF...
                </button>
            {% endif %}
            <button id="share-button" class="bg-gray-100 text-gray-700 px-4 sm:px-6 py-3 rounded-lg hover:bg-gray-200 transition-colors text-sm sm:text-base">
                üì§ Compartilhar
            </button>
        </div>
        
        {% if petition.deadline %}
            <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm text-yellow-800">
                    ‚è∞ Prazo: {{ petition.deadline|date:"d/m/Y" }}
                    {% if petition.days_remaining %}
                        ({{ petition.days_remaining }} dias restantes)
                    {% else %}
                        (Encerrado)
                    {% endif %}
                </p>
            </div>
        {% endif %}
    </div>
    
    <!-- Petition Description -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 md:p-8 mb-4 md:mb-6">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-3 md:mb-4">Sobre esta Peti√ß√£o</h2>
        <div class="prose max-w-none text-gray-700 text-sm sm:text-base">
            {{ petition.description|linebreaks }}
        </div>
    </div>
    
    <!-- How to Sign -->
    {% if petition.pdf_url %}
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 md:p-8 mb-4 md:mb-6">
        <div class="flex flex-col sm:flex-row items-start justify-between mb-4 gap-3">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Como Assinar esta Peti√ß√£o</h2>
            <a href="{% url 'petitions:how_to_sign' %}" class="text-xs sm:text-sm text-blue-600 hover:text-blue-800 font-semibold whitespace-nowrap">
                üìñ Guia completo ‚Üí
            </a>
        </div>
        <div class="space-y-3 md:space-y-4">
            <div class="flex items-start space-x-2 sm:space-x-3">
                <span class="flex-shrink-0 w-6 h-6 sm:w-8 sm:h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-sm sm:text-base">1</span>
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-900 text-sm sm:text-base">Baixe o PDF da peti√ß√£o</h3>
                    <p class="text-gray-600 text-xs sm:text-sm">Clique no bot√£o acima para baixar o documento PDF oficial desta peti√ß√£o.</p>
                </div>
            </div>
            <div class="flex items-start space-x-2 sm:space-x-3">
                <span class="flex-shrink-0 w-6 h-6 sm:w-8 sm:h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-sm sm:text-base">2</span>
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-900 text-sm sm:text-base">Assine digitalmente com Gov.br</h3>
                    <p class="text-gray-600 text-xs sm:text-sm">Acesse o <a href="https://assinador.iti.br/assinatura/" target="_blank" class="text-blue-600 hover:underline">Assinador Gov.br</a> e assine o PDF com sua conta Gov.br (n√≠vel prata ou ouro).</p>
                </div>
            </div>
            <div class="flex items-start space-x-2 sm:space-x-3 bg-yellow-50 border-l-4 border-yellow-500 p-3 rounded">
                <span class="flex-shrink-0 w-6 h-6 sm:w-8 sm:h-8 bg-yellow-600 text-white rounded-full flex items-center justify-center font-bold text-sm sm:text-base">3</span>
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-900 text-sm sm:text-base">‚ö†Ô∏è RETORNE AQUI e envie o PDF assinado</h3>
                    <p class="text-gray-700 text-xs sm:text-sm font-medium">Ap√≥s assinar no Gov.br, voc√™ DEVE retornar a esta p√°gina e fazer o upload do PDF assinado para que sua assinatura seja validada e contabilizada!</p>
                </div>
            </div>
        </div>
        <div class="bg-blue-50 rounded-lg p-4 mt-4 border border-blue-200">
            <p class="text-sm text-gray-700">
                <strong>üí° Primeira vez assinando digitalmente?</strong> 
                Confira nosso <a href="{% url 'petitions:how_to_sign' %}" class="text-blue-600 hover:underline font-semibold">guia passo a passo com imagens</a> 
                sobre como usar o Assinador Gov.br.
            </p>
        </div>
        <div class="mt-6 flex gap-4">
            <a href="{% url 'signatures:submit' uuid=petition.uuid %}" class="inline-block bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                ‚úçÔ∏è Enviar PDF Assinado
            </a>
            <a href="{% url 'petitions:how_to_sign' %}" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                üìñ Ver Guia Completo
            </a>
        </div>
    </div>
    {% endif %}
    
    <!-- Creator Actions (Bulk Download) -->
    {% if user == petition.creator and petition.signature_count > 0 %}
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 md:p-8 mb-4 md:mb-6 border-l-4 border-blue-500">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-3">A√ß√µes do Criador</h2>
        <p class="text-gray-700 mb-4 text-sm sm:text-base">
            Como criador desta peti√ß√£o, voc√™ pode visualizar e baixar todas as assinaturas verificadas com seus certificados de cust√≥dia.
        </p>
        <div class="flex flex-col sm:flex-row gap-3 mb-4">
            <a href="{% url 'signatures:petition_signatures' uuid=petition.uuid %}" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold transition-colors text-center text-sm sm:text-base">
                üìã Ver Lista de Assinaturas
            </a>
            <form method="post" action="{% url 'petitions:request_bulk_download' petition.uuid %}" class="flex-1">
                {% csrf_token %}
                <button type="submit" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold transition-colors text-sm sm:text-base">
                    üì¶ Baixar Pacote Completo
                </button>
            </form>
        </div>
        <div class="mt-4 p-4 bg-gray-50 rounded-lg text-xs sm:text-sm text-gray-600">
            <p class="mb-2"><strong>Voc√™ receber√° um email com link para download de um arquivo ZIP contendo:</strong></p>
            <ul class="list-disc ml-5 space-y-1">
                <li>Todos os PDFs assinados ({{ petition.signature_count }})</li>
                <li>Todos os certificados de cadeia de cust√≥dia</li>
                <li>Planilha CSV com metadados (nome e CPF hash)</li>
                <li>Arquivo README com instru√ß√µes</li>
            </ul>
            <p class="mt-2 text-xs"><em>‚è∞ Link v√°lido por 7 dias ap√≥s gera√ß√£o</em></p>
        </div>
    </div>
    {% endif %}
    
    <!-- Recent Signatures -->
    {% if recent_signatures %}
        <div class="bg-white rounded-lg shadow-md p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Assinaturas Recentes</h2>
            <div class="space-y-3">
                {% for signature in recent_signatures %}
                    <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded">
                        <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-semibold">
                            {{ signature.full_name.0 }}
                        </div>
                        <div class="flex-1">
                            <p class="font-medium text-gray-900">{{ signature.display_name }}</p>
                            <p class="text-sm text-gray-600">Assinatura verificada</p>
                        </div>
                        <span class="text-sm text-gray-500">{{ signature.verified_at|date:"d/m/Y" }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script>
    // Share configuration
    const PETITION_UUID = "{{ petition.uuid }}";
    const PETITION_TITLE = "{{ petition.title|escapejs }}";
    const PETITION_URL = "{{ petition.get_canonical_url }}";
</script>
<script src="{% static 'js/share.js' %}"></script>
{% endblock %}
